<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ChoiceScript Scene Extractor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <link rel="shortcut icon" href="./icon.png" type="image/x-icon" />
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, Oxygen, Ubuntu, sans-serif;
                background: linear-gradient(
                    135deg,
                    #1a1a2e 0%,
                    #16213e 50%,
                    #0f3460 100%
                );
                min-height: 100vh;
                color: #e0e0e0;
                padding: 20px;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 40px;
                padding: 20px;
            }

            h1 {
                font-size: 2.5rem;
                color: #00d4ff;
                margin-bottom: 10px;
                text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            }

            .subtitle {
                color: #888;
                font-size: 1.1rem;
            }

            .upload-section {
                background: rgba(255, 255, 255, 0.05);
                border: 2px dashed rgba(0, 212, 255, 0.3);
                border-radius: 16px;
                padding: 60px 40px;
                text-align: center;
                transition: all 0.3s ease;
                cursor: pointer;
                margin-bottom: 30px;
            }

            .upload-section:hover {
                border-color: #00d4ff;
                background: rgba(0, 212, 255, 0.05);
            }

            .upload-section.dragover {
                border-color: #00ff88;
                background: rgba(0, 255, 136, 0.1);
                transform: scale(1.02);
            }

            .upload-icon {
                font-size: 4rem;
                margin-bottom: 20px;
            }

            .upload-text {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .upload-hint {
                color: #666;
                font-size: 0.9rem;
            }

            #fileInput {
                display: none;
            }

            .status {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                display: none;
            }

            .status.show {
                display: block;
            }

            .status.error {
                background: rgba(255, 82, 82, 0.1);
                border: 1px solid rgba(255, 82, 82, 0.3);
            }

            .status.success {
                background: rgba(0, 255, 136, 0.1);
                border: 1px solid rgba(0, 255, 136, 0.3);
            }

            .status-icon {
                font-size: 1.5rem;
                margin-right: 10px;
            }

            .results {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 25px;
                display: none;
            }

            .results.show {
                display: block;
            }

            .results h2 {
                color: #00d4ff;
                margin-bottom: 20px;
                font-size: 1.4rem;
            }

            .scene-list {
                max-height: 300px;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
            }

            .scene-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 6px;
                margin-bottom: 8px;
                transition: background 0.2s ease;
            }

            .scene-item:hover {
                background: rgba(255, 255, 255, 0.08);
            }

            .scene-name {
                font-family: "Consolas", "Monaco", monospace;
                color: #00ff88;
            }

            .scene-lines {
                color: #888;
                font-size: 0.85rem;
            }

            .download-btn {
                width: 100%;
                padding: 18px 30px;
                font-size: 1.2rem;
                background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
                color: #1a1a2e;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .download-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            }

            .download-btn:active {
                transform: translateY(0);
            }

            .stats {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }

            .stat-card {
                flex: 1;
                background: rgba(0, 0, 0, 0.2);
                padding: 20px;
                border-radius: 10px;
                text-align: center;
            }

            .stat-number {
                font-size: 2rem;
                font-weight: bold;
                color: #00d4ff;
            }

            .stat-label {
                color: #888;
                font-size: 0.9rem;
                margin-top: 5px;
            }

            .instructions {
                background: rgba(255, 255, 255, 0.03);
                border-radius: 12px;
                padding: 25px;
                margin-top: 30px;
            }

            .instructions h3 {
                color: #00d4ff;
                margin-bottom: 15px;
            }

            .instructions ol {
                padding-left: 20px;
                line-height: 1.8;
                color: #aaa;
            }

            .instructions li {
                margin-bottom: 8px;
            }

            .instructions code {
                background: rgba(0, 212, 255, 0.1);
                padding: 2px 8px;
                border-radius: 4px;
                font-family: "Consolas", "Monaco", monospace;
                color: #00d4ff;
            }

            footer {
                text-align: center;
                margin-top: 40px;
                color: #555;
                font-size: 0.9rem;
            }

            /* Scrollbar styling */
            .scene-list::-webkit-scrollbar {
                width: 8px;
            }

            .scene-list::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
            }

            .scene-list::-webkit-scrollbar-thumb {
                background: rgba(0, 212, 255, 0.3);
                border-radius: 4px;
            }

            .scene-list::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 212, 255, 0.5);
            }

            @media (max-width: 600px) {
                h1 {
                    font-size: 1.8rem;
                }

                .upload-section {
                    padding: 40px 20px;
                }

                .stats {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üìñ ChoiceScript Scene Extractor</h1>
                <p class="subtitle">
                    Extract scene files from compiled ChoiceScript games
                </p>
            </header>

            <div class="upload-section" id="dropZone">
                <div class="upload-icon">üìÅ</div>
                <p class="upload-text">
                    Drop your compiled <strong>index.html</strong> here
                </p>
                <p class="upload-hint">or click to browse</p>
                <input type="file" id="fileInput" accept=".html" />
            </div>

            <div class="status" id="status">
                <span class="status-icon" id="statusIcon"></span>
                <span id="statusText"></span>
            </div>

            <div class="results" id="results">
                <h2>üìÇ Extracted Scenes</h2>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="sceneCount">0</div>
                        <div class="stat-label">Scene Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lineCount">0</div>
                        <div class="stat-label">Total Lines</div>
                    </div>
                </div>

                <div class="scene-list" id="sceneList"></div>

                <button class="download-btn" id="downloadBtn">
                    <span>‚¨áÔ∏è</span>
                    <span>Download scenes.zip</span>
                </button>
            </div>

            <div class="instructions">
                <h3>üìã How to Use</h3>
                <ol>
                    <li>
                        Compile your ChoiceScript game using
                        <code>compile.html</code>
                    </li>
                    <li>
                        Upload the resulting <code>index.html</code> file above
                    </li>
                    <li>Review the extracted scene files</li>
                    <li>
                        Click the download button to get <code>scenes.zip</code>
                    </li>
                </ol>
            </div>

            <footer>
                <p>
                    Works with compiled ChoiceScript games that contain the
                    <code>allScenes</code> object
                </p>
            </footer>
        </div>

        <script>
            const dropZone = document.getElementById("dropZone");
            const fileInput = document.getElementById("fileInput");
            const status = document.getElementById("status");
            const statusIcon = document.getElementById("statusIcon");
            const statusText = document.getElementById("statusText");
            const results = document.getElementById("results");
            const sceneList = document.getElementById("sceneList");
            const sceneCount = document.getElementById("sceneCount");
            const lineCount = document.getElementById("lineCount");
            const downloadBtn = document.getElementById("downloadBtn");

            let extractedScenes = null;

            // Drag and drop handlers
            dropZone.addEventListener("click", () => fileInput.click());

            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("dragover");
            });

            dropZone.addEventListener("dragleave", () => {
                dropZone.classList.remove("dragover");
            });

            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("dragover");
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            });

            function showStatus(message, type) {
                status.className = "status show " + type;
                statusIcon.textContent =
                    type === "error" ? "‚ùå" : type === "success" ? "‚úÖ" : "‚è≥";
                statusText.textContent = message;
            }

            function processFile(file) {
                if (!file.name.endsWith(".html")) {
                    showStatus("Please upload an HTML file", "error");
                    return;
                }

                showStatus("Processing file...", "");
                results.classList.remove("show");

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        extractedScenes = extractScenes(e.target.result);
                        displayResults(extractedScenes);
                        showStatus(
                            `Successfully extracted ${
                                Object.keys(extractedScenes).length
                            } scene files!`,
                            "success"
                        );
                    } catch (error) {
                        console.error(error);
                        showStatus("Error: " + error.message, "error");
                    }
                };
                reader.onerror = () => {
                    showStatus("Failed to read file", "error");
                };
                reader.readAsText(file);
            }

            function extractScenes(htmlContent) {
                // Find the allScenes object in the HTML
                const allScenesMatch = htmlContent.match(
                    /allScenes\s*=\s*(\{[\s\S]*?\});?\s*<\/script>/
                );

                if (!allScenesMatch) {
                    // Try alternative pattern - sometimes it's formatted differently
                    const altMatch = htmlContent.match(
                        /allScenes\s*=\s*(\{[\s\S]*?)\s*(?:;?\s*<\/script>|;\s*var\s+)/
                    );
                    if (!altMatch) {
                        throw new Error(
                            "Could not find allScenes object. Make sure this is a compiled ChoiceScript index.html file."
                        );
                    }
                    return parseAllScenes(altMatch[1]);
                }

                return parseAllScenes(allScenesMatch[1]);
            }

            function parseAllScenes(jsonStr) {
                // The allScenes object has scene names as keys, and objects with "lines" arrays as values
                let allScenes;

                try {
                    // Try to parse as JSON directly
                    allScenes = JSON.parse(jsonStr);
                } catch (e) {
                    // If that fails, try to evaluate it (it might be valid JS but not valid JSON)
                    try {
                        // Create a sandboxed function to evaluate the object
                        allScenes = new Function("return " + jsonStr)();
                    } catch (e2) {
                        throw new Error(
                            "Failed to parse scene data. The file may be corrupted or in an unsupported format."
                        );
                    }
                }

                const scenes = {};

                for (const [sceneName, sceneData] of Object.entries(
                    allScenes
                )) {
                    if (
                        sceneData &&
                        sceneData.lines &&
                        Array.isArray(sceneData.lines)
                    ) {
                        // Join the lines array to create the .txt content
                        scenes[sceneName] = sceneData.lines.join("\n");
                    }
                }

                if (Object.keys(scenes).length === 0) {
                    throw new Error("No valid scenes found in the file.");
                }

                return scenes;
            }

            function displayResults(scenes) {
                const sceneNames = Object.keys(scenes);
                let totalLines = 0;

                sceneList.innerHTML = "";

                sceneNames.forEach((name) => {
                    const lines = scenes[name].split("\n").length;
                    totalLines += lines;

                    const item = document.createElement("div");
                    item.className = "scene-item";
                    item.innerHTML = `
                    <span class="scene-name">${name}.txt</span>
                    <span class="scene-lines">${lines.toLocaleString()} lines</span>
                `;
                    sceneList.appendChild(item);
                });

                sceneCount.textContent = sceneNames.length;
                lineCount.textContent = totalLines.toLocaleString();
                results.classList.add("show");
            }

            downloadBtn.addEventListener("click", async () => {
                if (!extractedScenes) return;

                downloadBtn.disabled = true;
                downloadBtn.innerHTML =
                    "<span>‚è≥</span><span>Creating ZIP...</span>";

                try {
                    const zip = new JSZip();
                    const scenesFolder = zip.folder("scenes");

                    for (const [sceneName, content] of Object.entries(
                        extractedScenes
                    )) {
                        scenesFolder.file(`${sceneName}.txt`, content);
                    }

                    const blob = await zip.generateAsync({ type: "blob" });

                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "scenes.zip";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    downloadBtn.innerHTML =
                        "<span>‚úÖ</span><span>Downloaded!</span>";
                    setTimeout(() => {
                        downloadBtn.innerHTML =
                            "<span>‚¨áÔ∏è</span><span>Download scenes.zip</span>";
                        downloadBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error(error);
                    downloadBtn.innerHTML =
                        "<span>‚ùå</span><span>Download failed</span>";
                    setTimeout(() => {
                        downloadBtn.innerHTML =
                            "<span>‚¨áÔ∏è</span><span>Download scenes.zip</span>";
                        downloadBtn.disabled = false;
                    }, 2000);
                }
            });
        </script>
    </body>
</html>
